=== Glass Unit ===
id: auth.validate_credentials
version: 0.1.0
language: typescript

=== Intent ===
purpose: Validate user credentials against stored hashes
source:
  kind: conversation
  sessionId: "12"
  quote: "Need to verify passwords securely"
parent: auth.authenticate_user
stakeholder: security
subIntents: []
approvalStatus: approved

=== Contract ===
requires:
  - "username is a non-empty string"
  - "password is a non-empty string"
guarantees:
  on_success:
    - "Returns true if credentials match"
    - "Password is never logged or stored in plaintext"
  on_failure:
    - "Returns false for invalid credentials"
    - "Error details do not leak password information"
invariants:
  - "Password comparison uses constant-time algorithm"
fails:
  - DatabaseUnavailable: "retry(3) then Error(ServiceUnavailable)"
advisories: []

=== Implementation ===
import * as bcrypt from "bcrypt";

interface CredentialStore {
  getUserHash(username: string): Promise<string | null>;
}

export async function validateCredentials(
  username: string,
  password: string,
  store: CredentialStore,
): Promise<boolean> {
  if (!username || !password) {
    return false;
  }

  const hash = await store.getUserHash(username);
  if (!hash) {
    // Constant-time comparison even for non-existent users
    await bcrypt.compare(password, "$2b$10$invalidhashforcomparison");
    return false;
  }

  return bcrypt.compare(password, hash);
}
